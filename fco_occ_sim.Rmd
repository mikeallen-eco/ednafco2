# libraries
```{r}
library(dplyr)
library(ggplot2)
source("R/sampsim_function.R")
```
# specify the model
```{r}
sink("JAGS/fco_occ_mod.txt")
cat("
model {

# Priors
mean.p ~ dunif(0, 1)          # Detection intercept on prob. scale
alpha0 <- logit(mean.p)       #   same on logit scale
mean.psi ~ dunif(0, 1)        # Occupancy intercept on prob. scale
beta0 <- logit(mean.psi)      #   same on logit scale
for(k in 1:1){                # 1:K terms in detection model
   alpha[k] ~ dnorm(0, 0.1)   # Covariates on logit(detection)
}
for(k in 1:1){               # 1:K terms in occupancy model
   beta[k] ~ dnorm(0, 0.1)    # Covariates on logit(occupancy)
}

# Likelihood
for (i in 1:M) {
  z[i] ~ dbern(psi[i])
  logit(psi[i]) <- beta0 + inprod(beta[], occDM[i,])  
   for (j in 1:J) {
      y[i,j] ~ dbern(z[i] * p[i,j]) 
      logit(p[i,j]) <- alpha0 +     # detection (p) intercept
         inprod(alpha[], occDM[i,])    
   }
}

p.y1 <- mean.p
logit(p.y2) <- alpha0 + alpha[1]

psi.y1 <- mean.psi
logit(psi.y2) <- beta0 + beta[1]

}
",fill = TRUE)
sink()
```

# SIMULATE 1 YEAR OF J-VISIT DETECTION / NON-DETECTION AT n.sites SITES
WITH ONE COVARIATE FOR PSI AND ONE FOR P
```{r}

psi.y1.list <- list()
psi.y2.list <- list()
max.Rhat.list <- list()
biglist <- list()

for(j in seq(50, 1000, by = 50)) {
for (i in 1:100) {
message(paste0(j, " sites..."))
mod <- sampsim(n.sites = j, J = 3, psi.y1 = 0.5, chg = 0.15, chgdir = -1, 
               p0 = 0.4, p.chg = 0, p.chgdir = 0, seed = 100+i,
               iter = 5000)
psi.y1.list[[i]] <- data.frame(psi.y1 = mod$sims.list$psi.y1)
psi.y2.list[[i]] <- data.frame(psi.y2 = mod$sims.list$psi.y2, 
                               sites = j, max.Rhat = max(do.call(rbind, mod$Rhat)))
}

# put iterations in a dataframe and save to big list
df <- data.frame(
psi.y1 = bind_rows(psi.y1.list)[,1],
psi.y2 = bind_rows(psi.y2.list)[,1],
sites = bind_rows(psi.y2.list)[,2],
max.Rhat = bind_rows(psi.y2.list)[,3]
) %>%
  mutate(chg = psi.y2-psi.y1)

biglist[[j]] <- df

}

df_final <- bind_rows(biglist)

saveRDS(df_final, "output/df_J3_psi0.5_p0.4_chg0.15.rds")

df_final <- readRDS("output/df_J4_psi0.5_p0.4_chg0.15.rds")
quantile(df_final$chg, c(0.05, 0.5, 0.95))
quantile(df_final$psi.y1, c(0.05, 0.5, 0.95))
quantile(df_final$psi.y2, c(0.05, 0.5, 0.95))


```
√ [p (1-p) / n)] # SE of proportion
√ [p1(1-p1)/n1 + p2(1-p2)/n2] # SE of difference between 2 proportions

# Figure - p.time (60 and 40) - Trial A
```{r}
p.60a <- apply(tapaculo_60d$sims.list$p.time, 2, function(x) quantile(x, c(0.0275, 0.1, 0.5, 0.9, 0.975))) %>%
  t() %>%
  as.data.frame()

p.40a <- apply(tapaculo_40a$sims.list$p.time, 2, function(x) quantile(x, c(0.0275, 0.1, 0.5, 0.9, 0.975))) %>%
  t() %>%
  as.data.frame()

p.60a.plot <-
  data.frame(
    p.60a,
    time = seq(min(wind1), max(wind1), length.out = 50)) %>%
  mutate(n = "n=60")
colnames(p.60a.plot) <- c("p2.75", "p10", "p50", "p90", "p97.5", "timeofday", "n") 

p.40a.plot <-
  data.frame(
    p.40a,
    time = seq(min(wind1), max(wind1), length.out = 50)) %>%
  mutate(n = "n=40")
colnames(p.40a.plot) <- c("p2.75", "p10", "p50", "p90", "p97.5", "timeofday", "n")

runA_compare.plot <- p.60a.plot %>%
  bind_rows(p.40a.plot)

true.p = data.frame(
time = seq(min(wind1),max(wind1),length.out = 50)) %>%
  mutate(true = 100*plogis(time*(-2)))

ggplot(runA_compare.plot) +
  geom_ribbon(aes(x = timeofday, ymin = p2.75*100, ymax = p97.5*100, group = n),
              fill = "steelblue",
              alpha = 0.3) +
  geom_ribbon(aes(x = timeofday, ymin = p10*100, ymax = p90*100),
              fill = "steelblue",
              alpha = 0.3) +
  geom_line(aes(x = timeofday, y = p50*100), color = "steelblue", size = 2) +
  geom_line(data = true.p, aes(x = time, y = true)) +
  facet_wrap(~n) +
  labs(x = "Time", y = "Detection probability (%)") +
  theme_bw() +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 15))
#ggsave("figures/tapaculo_p_compare_trialA.png", width = 7, height = 5)
```
# Figure - psi.wetland (n = 60 and 40) - Trial A
```{r}
psi.60a <- apply(tapaculo_60a$sims.list$psi.wetland, 2, function(x) quantile(x, c(0.0275, 0.1, 0.5, 0.9, 0.975))) %>%
  t() %>%
  as.data.frame()

psi.40a <- apply(tapaculo_40a$sims.list$psi.wetland, 2, function(x) quantile(x, c(0.0275, 0.1, 0.5, 0.9, 0.975))) %>%
  t() %>%
  as.data.frame()

psi.60a.plot <-
  data.frame(
    psi.60a,
    time = seq(min(vegHt), max(vegHt), length.out = 50)) %>%
  mutate(n = "n=60")
colnames(psi.60a.plot) <- c("p2.75", "p10", "p50", "p90", "p97.5", "wetland", "n") 

psi.40a.plot <-
  data.frame(
    psi.40a,
    time = seq(min(vegHt), max(vegHt), length.out = 50)) %>%
  mutate(n = "n=40")
colnames(psi.40a.plot) <- c("p2.75", "p10", "p50", "p90", "p97.5", "wetland", "n")

runA_compare.psi.plot <- psi.60a.plot %>%
  bind_rows(psi.40a.plot)

true = data.frame(
wetland = seq(min(vegHt),max(vegHt),length.out = 50)) %>%
  mutate(true = 100*plogis(wetland*2 - 1.38))

ggplot(runA_compare.psi.plot) +
  geom_ribbon(aes(x = wetland, ymin = p2.75*100, ymax = p97.5*100, group = n),
              fill = "firebrick",
              alpha = 0.3) +
  geom_ribbon(aes(x = wetland, ymin = p10*100, ymax = p90*100),
              fill = "firebrick",
              alpha = 0.3) +
  geom_line(aes(x = wetland, y = p50*100), color = "firebrick", size = 2) +
  geom_line(data = true, aes(x = wetland, y = true)) +
  facet_wrap(~n) +
  labs(x = "Wetlands in surrounding area", y = "Occupancy probability (%)") +
  theme_bw() +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 15))
#ggsave("figures/tapaculo_psi_compare_trialA.png", width = 7, height = 5)
```
# Figure - p.time (60 and 40) - Trial B
```{r}
p.60b <- apply(tapaculo_60b$sims.list$p.time, 2, function(x) quantile(x, c(0.0275, 0.1, 0.5, 0.9, 0.975))) %>%
  t() %>%
  as.data.frame()

p.40b <- apply(tapaculo_40b$sims.list$p.time, 2, function(x) quantile(x, c(0.0275, 0.1, 0.5, 0.9, 0.975))) %>%
  t() %>%
  as.data.frame()

p.60b.plot <-
  data.frame(
    p.60b,
    time = seq(min(wind1), max(wind1), length.out = 50)) %>%
  mutate(n = "n=60")
colnames(p.60b.plot) <- c("p2.75", "p10", "p50", "p90", "p97.5", "timeofday", "n") 

p.40b.plot <-
  data.frame(
    p.40b,
    time = seq(min(wind1), max(wind1), length.out = 50)) %>%
  mutate(n = "n=40")
colnames(p.40b.plot) <- c("p2.75", "p10", "p50", "p90", "p97.5", "timeofday", "n")

runB_compare.plot <- p.60b.plot %>%
  bind_rows(p.40b.plot)

ggplot(runB_compare.plot) +
  geom_ribbon(aes(x = timeofday, ymin = p2.75*100, ymax = p97.5*100, group = n),
              fill = "steelblue",
              alpha = 0.3) +
  geom_ribbon(aes(x = timeofday, ymin = p10*100, ymax = p90*100),
              fill = "steelblue",
              alpha = 0.3) +
  geom_line(aes(x = timeofday, y = p50*100), color = "steelblue", size = 2) +
  geom_line(data = true.p, aes(x = time, y = true)) +
  facet_wrap(~n) +
  labs(x = "Time", y = "Detection probability (%)") +
  theme_bw() +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 15))
#ggsave("figures/tapaculo_p_compare_trialB.png", width = 7, height = 5)
```
# Figure - psi.wetland (n = 60 and 40) - Trial B
```{r}
psi.60b <- apply(tapaculo_60b$sims.list$psi.wetland, 2, function(x) quantile(x, c(0.0275, 0.1, 0.5, 0.9, 0.975))) %>%
  t() %>%
  as.data.frame()

psi.40b <- apply(tapaculo_40b$sims.list$psi.wetland, 2, function(x) quantile(x, c(0.0275, 0.1, 0.5, 0.9, 0.975))) %>%
  t() %>%
  as.data.frame()

psi.60b.plot <-
  data.frame(
    psi.60b,
    time = seq(min(vegHt), max(vegHt), length.out = 50)) %>%
  mutate(n = "n=60")
colnames(psi.60b.plot) <- c("p2.75", "p10", "p50", "p90", "p97.5", "wetland", "n") 

psi.40b.plot <-
  data.frame(
    psi.40b,
    time = seq(min(vegHt), max(vegHt), length.out = 50)) %>%
  mutate(n = "n=40")
colnames(psi.40b.plot) <- c("p2.75", "p10", "p50", "p90", "p97.5", "wetland", "n")

runB_compare.psi.plot <- psi.60b.plot %>%
  bind_rows(psi.40b.plot)

ggplot(runB_compare.psi.plot) +
  geom_ribbon(aes(x = wetland, ymin = p2.75*100, ymax = p97.5*100, group = n),
              fill = "firebrick",
              alpha = 0.3) +
  geom_ribbon(aes(x = wetland, ymin = p10*100, ymax = p90*100),
              fill = "firebrick",
              alpha = 0.3) +
  geom_line(aes(x = wetland, y = p50*100), color = "firebrick", size = 2) +
  geom_line(data = true, aes(x = wetland, y = true)) +
  facet_wrap(~n) +
  labs(x = "Wetlands in surrounding area", y = "Occupancy probability (%)") +
  theme_bw() +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 15))
#ggsave("figures/tapaculo_psi_compare_trialB.png", width = 7, height = 5)
```
# Figure - p.time (60 and 40) - Trial C
```{r}
p.60c <- apply(tapaculo_60c$sims.list$p.time, 2, function(x) quantile(x, c(0.0275, 0.1, 0.5, 0.9, 0.975))) %>%
  t() %>%
  as.data.frame()

p.40c <- apply(tapaculo_40c$sims.list$p.time, 2, function(x) quantile(x, c(0.0275, 0.1, 0.5, 0.9, 0.975))) %>%
  t() %>%
  as.data.frame()

p.60c.plot <-
  data.frame(
    p.60c,
    time = seq(min(wind1), max(wind1), length.out = 50)) %>%
  mutate(n = "n=60")
colnames(p.60c.plot) <- c("p2.75", "p10", "p50", "p90", "p97.5", "timeofday", "n") 

p.40c.plot <-
  data.frame(
    p.40c,
    time = seq(min(wind1), max(wind1), length.out = 50)) %>%
  mutate(n = "n=40")
colnames(p.40c.plot) <- c("p2.75", "p10", "p50", "p90", "p97.5", "timeofday", "n")

runC_compare.plot <- p.60c.plot %>%
  bind_rows(p.40c.plot)

ggplot(runC_compare.plot) +
  geom_ribbon(aes(x = timeofday, ymin = p2.75*100, ymax = p97.5*100, group = n),
              fill = "steelblue",
              alpha = 0.3) +
  geom_ribbon(aes(x = timeofday, ymin = p10*100, ymax = p90*100),
              fill = "steelblue",
              alpha = 0.3) +
  geom_line(aes(x = timeofday, y = p50*100), color = "steelblue", size = 2) +
  geom_line(data = true.p, aes(x = time, y = true)) +
  facet_wrap(~n) +
  labs(x = "Time", y = "Detection probability (%)") +
  theme_bw() +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 15))
#ggsave("figures/tapaculo_p_compare_trialC.png", width = 7, height = 5)
```
# Figure - psi.wetland (n = 60 and 40) - Trial C
```{r}
psi.60c <- apply(tapaculo_60c$sims.list$psi.wetland, 2, function(x) quantile(x, c(0.0275, 0.1, 0.5, 0.9, 0.975))) %>%
  t() %>%
  as.data.frame()

psi.40c <- apply(tapaculo_40c$sims.list$psi.wetland, 2, function(x) quantile(x, c(0.0275, 0.1, 0.5, 0.9, 0.975))) %>%
  t() %>%
  as.data.frame()

psi.60c.plot <-
  data.frame(
    psi.60c,
    time = seq(min(vegHt), max(vegHt), length.out = 50)) %>%
  mutate(n = "n=60")
colnames(psi.60c.plot) <- c("p2.75", "p10", "p50", "p90", "p97.5", "wetland", "n") 

psi.40c.plot <-
  data.frame(
    psi.40c,
    time = seq(min(vegHt), max(vegHt), length.out = 50)) %>%
  mutate(n = "n=40")
colnames(psi.40c.plot) <- c("p2.75", "p10", "p50", "p90", "p97.5", "wetland", "n")

runC_compare.psi.plot <- psi.60c.plot %>%
  bind_rows(psi.40c.plot)

ggplot(runC_compare.psi.plot) +
  geom_ribbon(aes(x = wetland, ymin = p2.75*100, ymax = p97.5*100, group = n),
              fill = "firebrick",
              alpha = 0.3) +
  geom_ribbon(aes(x = wetland, ymin = p10*100, ymax = p90*100),
              fill = "firebrick",
              alpha = 0.3) +
  geom_line(aes(x = wetland, y = p50*100), color = "firebrick", size = 2) +
  geom_line(data = true, aes(x = wetland, y = true)) +
  facet_wrap(~n) +
  labs(x = "Wetlands in surrounding area", y = "Occupancy probability (%)") +
  theme_bw() +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 15))
#ggsave("figures/tapaculo_psi_compare_trialC.png", width = 7, height = 5)
```
# Figure - p.time (60 and 40) - Trial D
```{r}
p.60d <- apply(tapaculo_60d$sims.list$p.time, 2, function(x) quantile(x, c(0.0275, 0.1, 0.5, 0.9, 0.975))) %>%
  t() %>%
  as.data.frame()

p.40d <- apply(tapaculo_40d$sims.list$p.time, 2, function(x) quantile(x, c(0.0275, 0.1, 0.5, 0.9, 0.975))) %>%
  t() %>%
  as.data.frame()

p.60d.plot <-
  data.frame(
    p.60d,
    time = seq(min(wind1), max(wind1), length.out = 50)) %>%
  mutate(n = "n=60")
colnames(p.60d.plot) <- c("p2.75", "p10", "p50", "p90", "p97.5", "timeofday", "n") 

p.40d.plot <-
  data.frame(
    p.40d,
    time = seq(min(wind1), max(wind1), length.out = 50)) %>%
  mutate(n = "n=40")
colnames(p.40d.plot) <- c("p2.75", "p10", "p50", "p90", "p97.5", "timeofday", "n")

runD_compare.plot <- p.60d.plot %>%
  bind_rows(p.40d.plot)

ggplot(runD_compare.plot) +
  geom_ribbon(aes(x = timeofday, ymin = p2.75*100, ymax = p97.5*100, group = n),
              fill = "steelblue",
              alpha = 0.3) +
  geom_ribbon(aes(x = timeofday, ymin = p10*100, ymax = p90*100),
              fill = "steelblue",
              alpha = 0.3) +
  geom_line(aes(x = timeofday, y = p50*100), color = "steelblue", size = 2) +
  geom_line(data = true.p, aes(x = time, y = true)) +
  facet_wrap(~n) +
  labs(x = "Time", y = "Detection probability (%)") +
  theme_bw() +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 15))
#ggsave("figures/tapaculo_p_compare_trialD.png", width = 7, height = 5)
```
# Figure - psi.wetland (n = 60 and 40) - Trial D
```{r}
psi.60d <- apply(tapaculo_60d$sims.list$psi.wetland, 2, function(x) quantile(x, c(0.0275, 0.1, 0.5, 0.9, 0.975))) %>%
  t() %>%
  as.data.frame()

psi.40d <- apply(tapaculo_40d$sims.list$psi.wetland, 2, function(x) quantile(x, c(0.0275, 0.1, 0.5, 0.9, 0.975))) %>%
  t() %>%
  as.data.frame()

psi.60d.plot <-
  data.frame(
    psi.60d,
    time = seq(min(vegHt), max(vegHt), length.out = 50)) %>%
  mutate(n = "n=60")
colnames(psi.60d.plot) <- c("p2.75", "p10", "p50", "p90", "p97.5", "wetland", "n") 

psi.40d.plot <-
  data.frame(
    psi.40d,
    time = seq(min(vegHt), max(vegHt), length.out = 50)) %>%
  mutate(n = "n=40")
colnames(psi.40d.plot) <- c("p2.75", "p10", "p50", "p90", "p97.5", "wetland", "n")

runD_compare.psi.plot <- psi.60d.plot %>%
  bind_rows(psi.40d.plot)

ggplot(runD_compare.psi.plot) +
  geom_ribbon(aes(x = wetland, ymin = p2.75*100, ymax = p97.5*100, group = n),
              fill = "firebrick",
              alpha = 0.3) +
  geom_ribbon(aes(x = wetland, ymin = p10*100, ymax = p90*100),
              fill = "firebrick",
              alpha = 0.3) +
  geom_line(aes(x = wetland, y = p50*100), color = "firebrick", size = 2) +
  geom_line(data = true, aes(x = wetland, y = true)) +
  facet_wrap(~n) +
  labs(x = "Wetlands in surrounding area", y = "Occupancy probability (%)") +
  theme_bw() +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 15))
#ggsave("figures/tapaculo_psi_compare_trialD.png", width = 7, height = 5)
```