# libraries
```{r}
library(dplyr)
library(ggplot2)
source("R/sampsim_function.R")
```
# info
√ [p (1-p) / n)] # SE of proportion
√ [p1(1-p1)/n1 + p2(1-p2)/n2] # SE of difference between 2 proportions

# specify the model
```{r}
sink("JAGS/fco_occ_mod.txt")
cat("
model {

# Priors
mean.p ~ dunif(0, 1)          # Detection intercept on prob. scale
alpha0 <- logit(mean.p)       #   same on logit scale
mean.psi ~ dunif(0, 1)        # Occupancy intercept on prob. scale
beta0 <- logit(mean.psi)      #   same on logit scale
for(k in 1:1){                # 1:K terms in detection model
   alpha[k] ~ dnorm(0, 0.1)   # Covariates on logit(detection)
}
for(k in 1:1){               # 1:K terms in occupancy model
   beta[k] ~ dnorm(0, 0.1)    # Covariates on logit(occupancy)
}

# Likelihood
for (i in 1:M) {
  z[i] ~ dbern(psi[i])
  logit(psi[i]) <- beta0 + inprod(beta[], occDM[i,])  
   for (j in 1:J) {
      y[i,j] ~ dbern(z[i] * p[i,j]) 
      logit(p[i,j]) <- alpha0 +     # detection (p) intercept
         inprod(alpha[], occDM[i,])    
   }
}

p.y1 <- mean.p
logit(p.y2) <- alpha0 + alpha[1]

psi.y1 <- mean.psi
logit(psi.y2) <- beta0 + beta[1]

}
",fill = TRUE)
sink()
```

# SIMULATE 2 YEARS OF J-VISIT DETECTION / NON-DETECTION AT n.sites SITES
With a year covariate for psi and constant p
```{r}

psi.y1.list <- list()
psi.y2.list <- list()
max.Rhat.list <- list()
biglist <- list()

for(j in seq(50, 1000, by = 50)) {
for (i in 1:100) {
message(paste0(j, " sites..."))
mod <- sampsim(n.sites = j, J = 3, psi.y1 = 0.5, chg = 0.15, chgdir = -1, 
               p0 = 0.4, p.chg = 0, p.chgdir = 0, seed = 100+i,
               iter = 5000)
psi.y1.list[[i]] <- data.frame(psi.y1 = mod$sims.list$psi.y1)
psi.y2.list[[i]] <- data.frame(psi.y2 = mod$sims.list$psi.y2, 
                               sites = j, max.Rhat = max(do.call(rbind, mod$Rhat)))
}

# put iterations in a dataframe and save to big list
df <- data.frame(
psi.y1 = bind_rows(psi.y1.list)[,1],
psi.y2 = bind_rows(psi.y2.list)[,1],
sites = bind_rows(psi.y2.list)[,2],
max.Rhat = bind_rows(psi.y2.list)[,3]
) %>%
  mutate(chg = psi.y2-psi.y1)

biglist[[j]] <- df

}

df_final <- bind_rows(biglist)

saveRDS(df_final, "output/df_J3_psi0.5_p0.4_chg0.15.rds")
```
# Summarizing runs
```{r}

# create variable for "run" number
run = lapply(1:2000, FUN = function(x) rep(x, 3000)) %>%
  do.call(c, .) %>%
  as.data.frame() %>%
  rename(run = 1)

# load saved run output
df_finalJ4 <- readRDS("output/df_J4_psi0.5_p0.4_chg0.15.rds") %>%
  mutate(J = 4, 
         run = run$run)

df_finalJ3 <- readRDS("output/df_J3_psi0.5_p0.4_chg0.15.rds") %>%
  mutate(J = 3, 
         run = run$run)

rm(run)

# summarize 90% quantiles by run
df_final.sumJ3 <- split(df_finalJ3, f = df_finalJ3$run) %>% 
  lapply(X = ., FUN = function(x) {
    psi.y1 <- t(quantile(x$psi.y1, c(0.05, 0.95)))
    psi.y2 <- t(quantile(x$psi.y2, c(0.05, 0.95)))
    chg <- t(quantile(x$chg, c(0.05, 0.95)))
    info <- data.frame(sites = x$sites[1],
                       J = x$J[1],
                       max.Rhat = x$max.Rhat[1])
    df <- cbind(info, psi.y1, psi.y2, chg) %>%
      rename(psi.y1.10 = 4, psi.y1.90 = 5, psi.y2.10 = 6, psi.y2.90 = 7,
             chg.10 = 8, chg.90 = 9) %>%
      mutate(detect = ifelse(chg.90 < 0, 1, 0))
    return(df)
  }
  ) %>%
  bind_rows()

df_final.sumJ4 <- split(df_finalJ4, f = df_finalJ4$run) %>% 
  lapply(X = ., FUN = function(x) {
    psi.y1 <- t(quantile(x$psi.y1, c(0.05, 0.95)))
    psi.y2 <- t(quantile(x$psi.y2, c(0.05, 0.95)))
    chg <- t(quantile(x$chg, c(0.05, 0.95)))
    info <- data.frame(sites = x$sites[1],
                       J = x$J[1],
                       max.Rhat = x$max.Rhat[1])
    df <- cbind(info, psi.y1, psi.y2, chg) %>%
      rename(psi.y1.10 = 4, psi.y1.90 = 5, psi.y2.10 = 6, psi.y2.90 = 7,
             chg.10 = 8, chg.90 = 9) %>%
      mutate(detect = ifelse(chg.90 < 0, 1, 0))
    return(df)
  }
  ) %>%
  bind_rows()

df_final_sum <- bind_rows(df_final.sumJ3, df_final.sumJ4) %>%
  mutate(chg.CI.width = chg.90-chg.10)
rm(df_final.sumJ3, df_final.sumJ4, df_finalJ3, df_finalJ4)


```
# plot trend detection probability by sample size
things that affect power: psi, p, J, sites, magnitude of change, level of certainty (90% or 95% CI)
```{r}
df_final_sum %>%
  filter(max.Rhat < 1.1) %>%
ggplot() +
  geom_smooth(aes(x = sites, y = detect, color = as.factor(J)),
              method="glm",
    method.args=list(family="binomial")) +
  geom_hline(yintercept = 0.99, color = "darkgray", linetype = 2) +
  scale_color_manual(values = c("firebrick", "darkblue")) +
  scale_x_continuous(breaks = seq(0,1000,by = 100)) +
  labs(x = "Number of sampling sites",
       y = "Probability of correctly detecting a decline \n(from 50% to 35% occupancy)",
       color = "Subsamples") +
  theme_bw() +
  theme(text = element_text(size = 12))

ggsave("figures/prob_detecting_decline_psi0.5_0.35_p0.4_J3_J4_90CI.png", dpi = 400, width = 6, height = 5)

```
# plot CI width by sample size
things that affect power: psi, p, J, sites, magnitude of change, level of certainty (90% or 95% CI)
```{r}
df_final_sum %>%
  filter(max.Rhat < 1.1) %>%
  mutate(Jcat = case_when(J==3 ~ "3 subsamples",
                          TRUE ~ "4 subsamples")) %>%
ggplot() +
  geom_boxplot(aes(x = as.factor(sites), y = chg.CI.width, color = Jcat),
             alpha = 0.5) +
  scale_color_manual(values = c("firebrick", "darkblue")) +
  scale_y_continuous(breaks = seq(0,0.95,by = .1)) +
  # scale_x_continuous(breaks = seq(0,1000,by = 200)) +
  facet_wrap(~Jcat) +
  guides(color = "none") +
  labs(x = "Number of sampling sites",
       y = "90% CI width of decline estimate\n(50% to 35% occupancy)") +
  theme_bw() +
  theme(text = element_text(size = 12)) +
  coord_flip()

ggsave("figures/decline_CI_width_psi0.5_0.35_p0.4_J3_J4_90CI.png", dpi = 400, width = 6, height = 5)

```
# plot CI width of psi by sample size
things that affect power: psi, p, J, sites, magnitude of change, level of certainty (90% or 95% CI)
```{r}
y1 <- df_final_sum %>%
  select(sites:psi.y1.90) %>%
  mutate(CIwidth = psi.y1.90-psi.y1.10,
         psi = "Occupancy = 50%") %>%
  select(-psi.y1.10, -psi.y1.90)

y2 <- df_final_sum %>%
  select(sites:max.Rhat,psi.y2.10, psi.y2.90) %>%
  mutate(CIwidth = psi.y2.90-psi.y2.10,
         psi = "Occupancy = 35%") %>%
  select(-psi.y2.10, -psi.y2.90)
  
CIwidth = bind_rows(y1, y2)

CIwidth %>%
filter(max.Rhat < 1.1) %>%
  mutate(Jcat = case_when(J==3 ~ "3 subsamples",
                          TRUE ~ "4 subsamples")) %>%
ggplot() +
  geom_boxplot(aes(x = as.factor(sites), y = CIwidth, color = Jcat),
             alpha = 0.5) +
  scale_color_manual(values = c("firebrick", "darkblue")) +
  scale_y_continuous(breaks = seq(0,0.9,by = .1), limits = c(0,0.85)) +
  facet_wrap(~psi+Jcat) +
  labs(x = "Number of sampling sites",
       y = "90% CI width for occupancy",
       color = "Subsamples") +
  theme_bw() +
  theme(text = element_text(size = 12)) +
  guides(color = "none") +
  coord_flip()

ggsave("figures/psi_CI_width_psi0.5_0.35_p0.4_J3_J4_90CI_box.png", dpi = 400, width = 7, height = 7)

```

